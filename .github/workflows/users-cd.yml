name: Users CD Pipeline

on:
  push:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      deploy_to_acr:
        description: 'Fazer push no ACR?'
        required: true
        type: boolean
        default: true
      confirm_deploy:
        description: 'Confirmar deploy no Azure Web App?'
        required: true
        type: boolean
        default: false
      custom_image:
        description: 'Imagem customizada (ex: fiapcr.azurecr.io/fcg-users:1.2.3) - deixe vazio para usar latest'
        required: false
        type: string
        default: ''

permissions:
  contents: write

env:
  REGISTRY: ${{ secrets.AZURE_CONTAINER_REGISTRY_NAME }}.azurecr.io
  IMAGE_NAME: fcg-users

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      full_image: ${{ steps.final_output.outputs.full_image }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Generate version
      id: version
      run: |
        latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
        echo "Latest tag: $latest_tag"
        
        version_without_v=${latest_tag#v}
        IFS='.' read -r major minor patch <<< "$version_without_v"
        
        patch=$((patch + 1))
        new_version="$major.$minor.$patch"
        tag="v$new_version"
        
        echo "New version: $new_version"
        echo "version=$new_version" >> $GITHUB_OUTPUT
        echo "tag=$tag" >> $GITHUB_OUTPUT
    
    - name: Setup Docker Buildx
      if: ${{ github.event_name == 'push' || github.event.inputs.deploy_to_acr == 'true' }}
      uses: docker/setup-buildx-action@v3
    
    - name: Login to Azure Container Registry
      if: ${{ github.event_name == 'push' || github.event.inputs.deploy_to_acr == 'true' }}
      uses: azure/docker-login@v1
      with:
        login-server: ${{ env.REGISTRY }}
        username: ${{ secrets.AZURE_CONTAINER_REGISTRY_USERNAME }}
        password: ${{ secrets.AZURE_CONTAINER_REGISTRY_PASSWORD }}
    
    - name: Build and push Docker image
      if: ${{ github.event_name == 'push' || github.event.inputs.deploy_to_acr == 'true' }}
      id: image
      run: |
        IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
        FULL_IMAGE="${IMAGE}:${{ steps.version.outputs.version }}"
        LATEST_IMAGE="${IMAGE}:latest"
        
        docker build \
          --file src/FCG.Users.WebApi/Dockerfile \
          --build-arg BUILD_CONFIGURATION=Release \
          -t ${FULL_IMAGE} \
          -t ${LATEST_IMAGE} \
          .
        
        docker push ${FULL_IMAGE}
        docker push ${LATEST_IMAGE}
        
        echo "full_image=${LATEST_IMAGE}" >> $GITHUB_OUTPUT
        echo "‚úÖ Image pushed: ${FULL_IMAGE}"
        echo "‚úÖ Image pushed: ${LATEST_IMAGE}"
    
    - name: Set final outputs
      id: final_output
      run: |
        if [ -z "${{ steps.image.outputs.full_image }}" ]; then
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          echo "full_image=${IMAGE}" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è  Build skipado, usando: ${IMAGE}"
        else
          echo "full_image=${{ steps.image.outputs.full_image }}" >> $GITHUB_OUTPUT
          echo "‚úÖ Usando imagem buildada: ${{ steps.image.outputs.full_image }}"
        fi
    
    - name: Create and push tag
      if: ${{ github.event_name == 'push' || github.event.inputs.deploy_to_acr == 'true' }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag -a ${{ steps.version.outputs.tag }} -m "Release ${{ steps.version.outputs.version }}"
        git push origin ${{ steps.version.outputs.tag }}
    
    - name: Create GitHub Release
      if: ${{ github.event_name == 'push' || github.event.inputs.deploy_to_acr == 'true' }}
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: Release ${{ steps.version.outputs.version }}
        generate_release_notes: true
  
  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' || github.event.inputs.confirm_deploy == 'true' }}
    environment: production
    
    steps:
    - name: Determine image to deploy
      id: deploy_image
      run: |
        if [ "${{ github.event.inputs.custom_image }}" != "" ]; then
          echo "image=${{ github.event.inputs.custom_image }}" >> $GITHUB_OUTPUT
          echo "üì¶ Using custom image: ${{ github.event.inputs.custom_image }}"
        else
          echo "image=${{ needs.build-and-push.outputs.full_image }}" >> $GITHUB_OUTPUT
          echo "üì¶ Using built image: ${{ needs.build-and-push.outputs.full_image }}"
        fi
    
    - name: Validate image output
      run: |
        if [ -z "${{ steps.deploy_image.outputs.image }}" ]; then
          echo "‚ùå ERROR: Image output is empty!"
          echo "Debug info:"
          echo "  build-and-push.outputs.full_image: ${{ needs.build-and-push.outputs.full_image }}"
          echo "  custom_image input: ${{ github.event.inputs.custom_image }}"
          exit 1
        fi
        echo "‚úÖ Image validated: ${{ steps.deploy_image.outputs.image }}"
    
    - name: Extract image tag
      id: image_tag
      run: |
        image="${{ steps.deploy_image.outputs.image }}"
        echo "üì¶ Full image: ${image}"
        
        if [[ "$image" == *:* ]]; then
          tag="${image##*:}"
        else
          tag="latest"
          echo "‚ö†Ô∏è  No tag found, defaulting to: latest"
        fi
        
        echo "tag=${tag}" >> $GITHUB_OUTPUT
        echo "üè∑Ô∏è  Extracted tag: ${tag}"
    
    - name: Set IMAGE_VERSION app setting via REST API
      run: |
        # Extrair username e password do publish-profile
        USERNAME=$(echo '${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}' | grep -oP '(?<=userName=")[^"]+' | head -1)
        PASSWORD=$(echo '${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}' | grep -oP '(?<=userPWD=")[^"]+' | head -1)
        
        WEBAPP_NAME="${{ secrets.AZURE_WEBAPP_NAME }}"
        TAG="${{ steps.image_tag.outputs.tag }}"
        
        echo "üîß Setting IMAGE_VERSION to: ${TAG}"
        
        # Fazer requisi√ß√£o para API do Azure Web App
        curl -X POST \
          "https://${WEBAPP_NAME}.scm.azurewebsites.net/api/settings" \
          -u "${USERNAME}:${PASSWORD}" \
          -H "Content-Type: application/json" \
          -d '{"IMAGE_VERSION":"'"${TAG}"'"}' \
          --fail
        
        echo "‚úÖ IMAGE_VERSION set to: ${TAG}"
    
    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        images: ${{ steps.deploy_image.outputs.image }}
    
    - name: Deployment Success
      run: |
        echo "=================================="
        echo "‚úÖ DEPLOY REALIZADO COM SUCESSO!"
        echo "=================================="
        echo ""
        echo "üöÄ Aplica√ß√£o dispon√≠vel em:"
        echo "   https://${{ secrets.AZURE_WEBAPP_NAME }}.azurewebsites.net"
        echo ""
        echo "üì¶ Imagem deployada:"
        echo "   ${{ steps.deploy_image.outputs.image }}"
        echo ""
        echo "üè∑Ô∏è  Vers√£o: ${{ steps.image_tag.outputs.tag }}"
        echo "=================================="
